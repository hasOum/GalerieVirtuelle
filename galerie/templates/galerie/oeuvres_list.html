{% extends 'galerie/base.html' %}
{% load static %}

{% block title %}Œuvres | GalerieVirtuelle{% endblock %}

{% block content %}

{# CSS page (crée ce fichier en static) #}
<link rel="stylesheet" href="{% static 'galerie/css/oeuvres.css' %}">

<div class="container py-4">

  {# HERO #}
  <div class="oeuvre-hero d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="oeuvre-title mb-1">Œuvres</h1>
      <div class="oeuvre-subtitle">Explorez, recherchez et filtrez les œuvres disponibles.</div>
    </div>

    <div class="oeuvre-count">
      {{ oeuvres|length }} résultat{{ oeuvres|length|pluralize }}
    </div>
  </div>

  {# FILTER CARD #}
  <div class="oeuvre-filter-card p-3 p-md-4 mb-4">
    <form method="get" class="row g-3 align-items-end">

      <div class="col-md-5">
        <label class="form-label mb-1">Mot clé</label>
        <input class="form-control" type="text" name="q"
               placeholder="Titre, artiste, description..."
               value="{{ q }}">
      </div>

      <div class="col-md-3">
        <label class="form-label mb-1">Catégorie</label>
        <select class="form-select" name="categorie">
          <option value="">Toutes catégories</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if categorie_selected == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.nom_categorie }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label mb-1">Artiste</label>
        <select class="form-select" name="artiste">
          <option value="">Tous les artistes</option>
          {% for a in artistes %}
            <option value="{{ a.id }}" {% if artiste_selected == a.id|stringformat:"s" %}selected{% endif %}>
              {{ a.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label mb-1">Technique</label>
        <select class="form-select" name="technique">
          <option value="">Toutes les techniques</option>
          {% for t in techniques %}
            <option value="{{ t }}" {% if technique == t %}selected{% endif %}>
              {{ t }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label mb-1">Prix min (€)</label>
        <input class="form-control" type="number" name="prix_min" placeholder="0" value="{{ prix_min }}" step="0.01">
      </div>

      <div class="col-md-2">
        <label class="form-label mb-1">Prix max (€)</label>
        <input class="form-control" type="number" name="prix_max" placeholder="5000" value="{{ prix_max }}" step="0.01">
      </div>

      <div class="col-md-3">
        <label class="form-label mb-1">Trier par</label>
        <select class="form-select" name="tri">
          <option value="recent" {% if tri == "recent" %}selected{% endif %}>Les plus récentes</option>
          <option value="prix_croissant" {% if tri == "prix_croissant" %}selected{% endif %}>Prix : croissant</option>
          <option value="prix_decroissant" {% if tri == "prix_decroissant" %}selected{% endif %}>Prix : décroissant</option>
          <option value="titre_az" {% if tri == "titre_az" %}selected{% endif %}>Titre : A-Z</option>
          <option value="titre_za" {% if tri == "titre_za" %}selected{% endif %}>Titre : Z-A</option>
          <option value="annee_croissant" {% if tri == "annee_croissant" %}selected{% endif %}>Année : ancienne</option>
          <option value="annee_decroissant" {% if tri == "annee_decroissant" %}selected{% endif %}>Année : récente</option>
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-gradient" type="submit">Filtrer</button>
      </div>

      <div class="col-12">
        <a class="btn btn-outline-secondary" href="{% url 'galerie:oeuvres_list' %}">Reset</a>
      </div>
    </form>
  </div>

  {# LIST / CARDS #}
  <div class="row g-4">
    {% for o in oeuvres %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="oeuvre-card h-100">

          <div class="oeuvre-img-wrap">
            {% if o.image %}
              <img class="oeuvre-img" src="{{ o.image.url }}" alt="{{ o.titre }}">
            {% else %}
              <div class="oeuvre-img oeuvre-img-placeholder d-flex align-items-center justify-content-center">
                <span class="text-muted fw-semibold">Aucune image</span>
              </div>
            {% endif %}

            <div class="oeuvre-badges-left">
              {% if o.prix %}
                <div class="oeuvre-price-badge-left">{{ o.prix|floatformat:0 }}€</div>
              {% endif %}
              {% if o.categorie %}
                <div class="oeuvre-badge">{{ o.categorie.nom_categorie }}</div>
              {% endif %}
            </div>

            {% if o.prix %}
              <div class="oeuvre-price-badge">{{ o.prix|floatformat:0 }}€</div>
            {% endif %}
          </div>

          <div class="oeuvre-body">
            <h5 class="oeuvre-name">{{ o.titre }}</h5>

            {% if o.artiste %}
              <div class="oeuvre-artist">{{ o.artiste }}</div>
            {% endif %}

            {% if o.description %}
              <div class="oeuvre-desc">{{ o.description|truncatewords:20 }}</div>
            {% endif %}

            <div class="oeuvre-meta mt-3">
              {% if o.annee %}
                <div class="oeuvre-meta-item">
                  <span class="oeuvre-meta-label">Année</span>
                  <span class="oeuvre-meta-value">{{ o.annee }}</span>
                </div>
              {% endif %}
            </div>

            {# Section Paiement/Achat #}
            <div class="oeuvre-payment mt-3">
              <div class="oeuvre-price-section">
                <span class="oeuvre-price-label">Prix:</span>
                <span class="oeuvre-price-value">{{ o.prix|floatformat:2 }}€</span>
              </div>
              
              <div class="oeuvre-stock-section">
                <span class="oeuvre-stock-label">Disponibilité:</span>
                {% if o.stock > 0 %}
                  <span class="oeuvre-stock-available">✓ {{ o.stock }} en stock</span>
                {% else %}
                  <span class="oeuvre-stock-unavailable">✗ Rupture de stock</span>
                {% endif %}
              </div>

              <div class="oeuvre-action-buttons mt-3 d-flex gap-2">
                <a class="btn btn-outline-dark flex-grow-1" href="{% url 'galerie:oeuvre_detail' o.id %}"> 
                  <i class="bi bi-info-circle me-1"></i>Détails
                </a>
                {% if o.est_disponible %}
                  <button class="btn btn-primary flex-grow-1" onclick="addToCart({{ o.id }}, '{{ o.titre }}', {{ o.prix }})">
                    <i class="bi bi-bag-plus me-1"></i>Ajouter
                  </button>
                {% else %}
                  <button class="btn btn-secondary flex-grow-1" disabled>
                    <i class="bi bi-x-circle me-1"></i>Indisponible
                  </button>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>

    {% empty %}
      <div class="col-12">
        <div class="oeuvre-empty text-center p-4 p-md-5">
          <h4 class="mb-2">Aucune œuvre trouvée</h4>
          <div class="text-muted mb-3">Essayez de modifier les filtres ou de réinitialiser la recherche.</div>
          <a class="btn btn-outline-secondary" href="{% url 'galerie:oeuvres_list' %}">Reset</a>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

{% endblock %}
