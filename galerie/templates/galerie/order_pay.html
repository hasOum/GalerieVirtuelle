{% extends 'galerie/base.html' %}
{% load static %}

{% block title %}Paiement | Commande #{{ commande.id }}{% endblock %}

{% block content %}
<style>
  .payment-container {
    max-width: 600px;
    margin: 3rem auto;
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .payment-header {
    text-align: center;
    margin-bottom: 2rem;
    border-bottom: 2px solid #4B749F;
    padding-bottom: 1.5rem;
  }

  .payment-header h1 {
    color: #243748;
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
  }

  .order-summary {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .summary-row:last-child {
    border-bottom: none;
  }

  .summary-label {
    font-weight: 500;
    color: #333;
  }

  .summary-value {
    font-weight: 600;
    color: #243748;
  }

  .summary-row.total {
    padding: 1rem 0;
    font-size: 1.2rem;
    color: #FF6B6B;
  }

  .payment-form {
    margin-bottom: 1.5rem;
  }

  #card-element {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 12px;
    background: white;
    font-size: 1rem;
  }

  #card-element.StripeElement--focus {
    border-color: #4B749F;
    box-shadow: 0 0 0 2px rgba(75, 116, 159, 0.1);
  }

  .error-message {
    color: #dc3545;
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }

  #card-error {
    color: #fa755a;
    margin-top: 0.5rem;
  }

  .btn-pay {
    width: 100%;
    padding: 0.75rem;
    font-size: 1.1rem;
    font-weight: 600;
    background: linear-gradient(135deg, #4B749F, #243748);
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 1rem;
  }

  .btn-pay:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(75, 116, 159, 0.3);
  }

  .btn-pay:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 0.5rem;
    vertical-align: middle;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .trust-indicators {
    display: flex;
    gap: 1.5rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
    text-align: center;
    justify-content: center;
  }

  .trust-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.9rem;
  }

  .trust-item i {
    font-size: 1.5rem;
    color: #4B749F;
  }
</style>

<div class="payment-container">
  <div class="payment-header">
    <h1><i class="bi bi-credit-card me-2"></i>Paiement sécurisé</h1>
    <p class="text-muted">Commande #{{ commande.id }}</p>
  </div>

  <!-- Résumé de la commande -->
  <div class="order-summary">
    <div class="summary-row">
      <span class="summary-label">Sous-total:</span>
      <span class="summary-value">{{ commande.total|floatformat:2 }}€</span>
    </div>
    <div class="summary-row total">
      <span class="summary-label">Montant à payer:</span>
      <span class="summary-value">{{ commande.total|floatformat:2 }}€</span>
    </div>
  </div>

  <!-- Formulaire Stripe -->
  <form id="payment-form" class="payment-form">
    {% csrf_token %}
    
    <label for="card-element" class="form-label">Informations de carte</label>
    <div id="card-element"></div>
    <div id="card-error" role="alert"></div>

    <button id="submit-btn" type="submit" class="btn-pay">
      <span class="loading-spinner" id="spinner"></span>
      <span id="button-text">Payer {{ commande.total|floatformat:2 }}€</span>
    </button>
  </form>

  <!-- Indicateurs de confiance -->
  <div class="trust-indicators">
    <div class="trust-item">
      <i class="bi bi-shield-check"></i>
      <span>Paiement sécurisé</span>
    </div>
    <div class="trust-item">
      <i class="bi bi-lock"></i>
      <span>Crypté SSL</span>
    </div>
    <div class="trust-item">
      <i class="bi bi-check-circle"></i>
      <span>Certificat</span>
    </div>
  </div>
</div>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>

<script>
const stripe = Stripe("{{ stripe_public_key }}");
const elements = stripe.elements();
const cardElement = elements.create("card");
cardElement.mount("#card-element");

// Handle real-time validation errors
cardElement.on("change", function(event) {
  const displayError = document.getElementById("card-error");
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = "";
  }
});

// Handle form submission
const form = document.getElementById("payment-form");
form.addEventListener("submit", async function(event) {
  event.preventDefault();

  const submitBtn = document.getElementById("submit-btn");
  const spinner = document.getElementById("spinner");
  const buttonText = document.getElementById("button-text");

  submitBtn.disabled = true;
  spinner.style.display = "inline-block";
  buttonText.textContent = "Traitement en cours...";

  try {
    // Confirm payment
    const response = await fetch("{% url 'galerie:payment_confirm' order_id=commande.id %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({
        payment_method: cardElement,
      }),
    });

    const data = await response.json();

    if (data.client_secret) {
      // Confirm card payment
      const { paymentIntent, error } = await stripe.confirmCardPayment(
        data.client_secret,
        {
          payment_method: {
            card: cardElement,
            billing_details: {},
          },
        }
      );

      if (error) {
        // Show error to customer
        document.getElementById("card-error").textContent = error.message;
        submitBtn.disabled = false;
        spinner.style.display = "none";
        buttonText.textContent = "Payer {{ commande.total|floatformat:2 }}€";
      } else if (paymentIntent.status === "succeeded") {
        // Payment successful
        window.location.href = "{% url 'galerie:payment_success' order_id=commande.id %}";
      }
    }
  } catch (error) {
    console.error("Error:", error);
    document.getElementById("card-error").textContent = "Une erreur est survenue";
    submitBtn.disabled = false;
    spinner.style.display = "none";
    buttonText.textContent = "Payer {{ commande.total|floatformat:2 }}€";
  }
});
</script>

{% endblock %}
